<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chia s·∫ª M√†n h√¨nh - PeerJS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .status.waiting {
            background: #fff3cd;
            color: #856404;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .share-link-container {
            display: none;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .share-link-container.active {
            display: block;
        }

        .share-link-container h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .link-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .link-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }

        .btn-copy {
            background: #28a745;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-copy:hover {
            background: #218838;
        }

        .qr-code {
            text-align: center;
            margin-top: 15px;
        }

        .qr-code canvas {
            border: 3px solid #667eea;
            border-radius: 10px;
            padding: 10px;
            background: white;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        video {
            width: 100%;
            height: auto;
            display: block;
        }

        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box p {
            margin: 5px 0;
            color: #333;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5em;
            }

            .controls {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∫ Chia s·∫ª M√†n h√¨nh</h1>
        
        <div id="status" class="status waiting">
            ƒêang kh·ªüi t·∫°o...
        </div>

        <div class="info-box">
            <p><strong>H∆∞·ªõng d·∫´n:</strong></p>
            <p id="instruction">Nh·∫•n "B·∫Øt ƒë·∫ßu chia s·∫ª" ƒë·ªÉ chia s·∫ª m√†n h√¨nh c·ªßa b·∫°n</p>
        </div>

        <div class="controls">
            <button id="startBtn" class="btn-primary">B·∫Øt ƒë·∫ßu Chia s·∫ª</button>
            <button id="stopBtn" class="btn-danger" style="display: none;">D·ª´ng Chia s·∫ª</button>
        </div>

        <div id="shareLinkContainer" class="share-link-container">
            <h3>üîó Link ƒë·ªÉ xem m√†n h√¨nh:</h3>
            <div class="link-box">
                <input type="text" id="shareLink" class="link-input" readonly>
                <button id="copyBtn" class="btn-copy">Copy</button>
            </div>
            <p style="color: #666; font-size: 14px;">Chia s·∫ª link n√†y ƒë·ªÉ ng∆∞·ªùi kh√°c xem m√†n h√¨nh c·ªßa b·∫°n</p>
        </div>

        <div class="video-container" style="display: none;" id="videoContainer">
            <video id="localVideo" autoplay muted playsinline></video>
            <div class="video-label">M√†n h√¨nh c·ªßa b·∫°n</div>
        </div>

        <div class="video-container" style="display: none;" id="remoteVideoContainer">
            <video id="remoteVideo" autoplay playsinline></video>
            <div class="video-label">M√†n h√¨nh ƒëang xem</div>
        </div>
    </div>

    <script>
        let peer = null;
        let localStream = null;
        let currentCall = null;
        const urlParams = new URLSearchParams(window.location.search);
        const viewerId = urlParams.get('id');
        const isViewer = !!viewerId;

        const elements = {
            status: document.getElementById('status'),
            instruction: document.getElementById('instruction'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            shareLink: document.getElementById('shareLink'),
            shareLinkContainer: document.getElementById('shareLinkContainer'),
            copyBtn: document.getElementById('copyBtn'),
            localVideo: document.getElementById('localVideo'),
            remoteVideo: document.getElementById('remoteVideo'),
            videoContainer: document.getElementById('videoContainer'),
            remoteVideoContainer: document.getElementById('remoteVideoContainer')
        };

        function updateStatus(message, type = 'waiting') {
            elements.status.textContent = message;
            elements.status.className = `status ${type}`;
        }

        function initPeer() {
            peer = new Peer({
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:global.stun.twilio.com:3478' }
                    ]
                }
            });

            peer.on('open', (id) => {
                console.log('Peer ID:', id);
                
                if (isViewer) {
                    connectToHost();
                } else {
                    updateStatus(`‚úÖ ƒê√£ s·∫µn s√†ng! Peer ID: ${id}`, 'connected');
                }
            });

            peer.on('call', (call) => {
                console.log('Nh·∫≠n cu·ªôc g·ªçi t·ª´:', call.peer);
                
                if (!isViewer) {
                    updateStatus('‚ö†Ô∏è C√≥ ng∆∞·ªùi ƒëang k·∫øt n·ªëi ƒë·ªÉ xem m√†n h√¨nh', 'waiting');
                }
                
                call.answer(localStream);
                currentCall = call;

                call.on('stream', (remoteStream) => {
                    console.log('Nh·∫≠n ƒë∆∞·ª£c stream');
                });

                call.on('close', () => {
                    console.log('Cu·ªôc g·ªçi ƒë√£ ƒë√≥ng');
                    if (!isViewer) {
                        updateStatus('üë§ Ng∆∞·ªùi xem ƒë√£ ng·∫Øt k·∫øt n·ªëi', 'waiting');
                    }
                });
            });

            peer.on('error', (err) => {
                console.error('L·ªói Peer:', err);
                updateStatus(`‚ùå L·ªói: ${err.type}`, 'error');
            });
        }

        async function startScreenShare() {
            try {
                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: "always"
                    },
                    audio: false
                });

                elements.localVideo.srcObject = localStream;
                elements.videoContainer.style.display = 'block';
                elements.startBtn.style.display = 'none';
                elements.stopBtn.style.display = 'inline-block';

                localStream.getVideoTracks()[0].onended = () => {
                    stopScreenShare();
                };

                const shareUrl = `${window.location.origin}${window.location.pathname}?id=${peer.id}`;
                elements.shareLink.value = shareUrl;
                elements.shareLinkContainer.classList.add('active');

                updateStatus('üé• ƒêang chia s·∫ª m√†n h√¨nh. S·∫µn s√†ng nh·∫≠n k·∫øt n·ªëi!', 'connected');
                elements.instruction.textContent = 'Chia s·∫ª link b√™n d∆∞·ªõi ƒë·ªÉ ng∆∞·ªùi kh√°c xem m√†n h√¨nh c·ªßa b·∫°n';

            } catch (err) {
                console.error('L·ªói khi l·∫•y m√†n h√¨nh:', err);
                updateStatus('‚ùå Kh√¥ng th·ªÉ l·∫•y m√†n h√¨nh. Vui l√≤ng th·ª≠ l·∫°i!', 'error');
            }
        }

        function stopScreenShare() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }

            elements.localVideo.srcObject = null;
            elements.videoContainer.style.display = 'none';
            elements.startBtn.style.display = 'inline-block';
            elements.stopBtn.style.display = 'none';
            elements.shareLinkContainer.classList.remove('active');

            updateStatus('‚úÖ ƒê√£ d·ª´ng chia s·∫ª m√†n h√¨nh', 'connected');
            elements.instruction.textContent = 'Nh·∫•n "B·∫Øt ƒë·∫ßu chia s·∫ª" ƒë·ªÉ chia s·∫ª m√†n h√¨nh c·ªßa b·∫°n';
        }

        function connectToHost() {
            updateStatus(`üîÑ ƒêang k·∫øt n·ªëi ƒë·∫øn: ${viewerId}`, 'waiting');
            elements.instruction.textContent = 'ƒêang k·∫øt n·ªëi ƒë·ªÉ xem m√†n h√¨nh...';
            elements.startBtn.style.display = 'none';

            const call = peer.call(viewerId, new MediaStream());
            currentCall = call;

            call.on('stream', (remoteStream) => {
                console.log('Nh·∫≠n ƒë∆∞·ª£c stream t·ª´ host');
                elements.remoteVideo.srcObject = remoteStream;
                elements.remoteVideoContainer.style.display = 'block';
                updateStatus('‚úÖ ƒê√£ k·∫øt n·ªëi! ƒêang xem m√†n h√¨nh', 'connected');
                elements.instruction.textContent = 'B·∫°n ƒëang xem m√†n h√¨nh ƒë∆∞·ª£c chia s·∫ª';
            });

            call.on('close', () => {
                console.log('K·∫øt n·ªëi ƒë√£ ƒë√≥ng');
                elements.remoteVideo.srcObject = null;
                elements.remoteVideoContainer.style.display = 'none';
                updateStatus('‚ùå K·∫øt n·ªëi ƒë√£ b·ªã ng·∫Øt', 'error');
                elements.instruction.textContent = 'Ng∆∞·ªùi chia s·∫ª ƒë√£ d·ª´ng chia s·∫ª m√†n h√¨nh';
            });

            call.on('error', (err) => {
                console.error('L·ªói cu·ªôc g·ªçi:', err);
                updateStatus('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi', 'error');
            });
        }

        elements.startBtn.addEventListener('click', startScreenShare);
        elements.stopBtn.addEventListener('click', stopScreenShare);

        elements.copyBtn.addEventListener('click', () => {
            elements.shareLink.select();
            document.execCommand('copy');
            
            const originalText = elements.copyBtn.textContent;
            elements.copyBtn.textContent = '‚úì ƒê√£ copy!';
            elements.copyBtn.style.background = '#218838';
            
            setTimeout(() => {
                elements.copyBtn.textContent = originalText;
                elements.copyBtn.style.background = '#28a745';
            }, 2000);
        });

        if (isViewer) {
            elements.instruction.textContent = 'B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô xem m√†n h√¨nh';
            updateStatus('üîÑ ƒêang kh·ªüi t·∫°o k·∫øt n·ªëi...', 'waiting');
        } else {
            updateStatus('üîÑ ƒêang kh·ªüi t·∫°o PeerJS...', 'waiting');
        }

        initPeer();
    </script>
</body>
</html>
